---
title: "In-Class Exercise 2"
author:
  - name: Matthew Ho
    url: https://www.linkedin.com/in/matthewhoyiwen/
date: 01-15-2023
description: |
  In-class exercise 2 description
categories:
  - In-class Exercise
format:
  html:
    toc: true
execute: 
  eval: true
  echo: true
  warning: false
---

## 1.0 Overview

## 2.0 Setup

### 2.1 Dependencies

-   arrow
-   lubridate
-   tidyverse
-   tmap
-   sf

```{r}
pacman::p_load(arrow, lubridate, tidyverse, sf, tmap)
```

### 2.2 Importing Data
#### Read the first parquet files

```{r}
# eval: FALSE - Show the code without evaluating
df <- read_parquet("data/GrabPosisi/part-00000-8bbff892-97d2-4011-9961-703e38972569.c000.snappy.parquet")
```

#### Import Master Plan 2019 Planning Subzone Boundary
```{r}
mpsz2019 <- st_read("data/dataGov/MPSZ2019.kml") %>%
  st_transform(crs = 3414)
```

### 2.3 Data Wrangling
#### Convert the ping timestamp to datetime
as_datetime is a lubridate function. 
Replace the column with the reformatted version.

lubridate helps to handle datetime data.
```{r}
df$pingtimestamp <- as_datetime(df$pingtimestamp)
```

#### Write the parquet data to rds
```{r}
write_rds(df, "data/rds/part0.rds")
```

#### Check the dataframe
```{r}
head(df)
```

#### Extract trip-start locations (Origins)

trj_id is a duplicated field, referring to the trip. Group by trip.
sort by time stamp
Filter out the origin in the first row
Use mutate to create new columns

```{r}
origin_df <- df %>%
  group_by(trj_id) %>%
  arrange(pingtimestamp) %>%
  filter(row_number()==1) %>%
  mutate(weekday = wday(pingtimestamp,
                        label=TRUE,
                        abbr=TRUE),
         start_hr = factor(hour(pingtimestamp)),
         day = factor(mday(pingtimestamp)))
```


#### Extract trip-end locations (Destinations)

Same as above, but use desc(pingtimestamp) to take the largest (end)

```{r}
destination_df <- df %>%
  group_by(trj_id) %>%
  arrange(desc(pingtimestamp)) %>%
  filter(row_number()==1) %>%
  mutate(weekday = wday(pingtimestamp,
                        label=TRUE,
                        abbr=TRUE),
         end_hr = factor(hour(pingtimestamp)),
         day = factor(mday(pingtimestamp)))
  
```

#### Important: Saving data, saving memory
Dataframes are large and the raw ones have many entries. Save the intermediate dataframes.
```{r}
# #|eval: FALSE - Show the code without evaluating
# #|echo: false - Code will not appear to the reader
write_rds(destination_df, "data/rds/destination_df.rds")
write_rds(origin_df, "data/rds/origin_df.rds")
```

#### Reimporting data
The old files are no longer needed, but we can keep it to show our process.
```{r}
destination_df <- read_rds("data/rds/destination_df.rds")
origin_df <- read_rds("data/rds/origin_df.rds")
```
