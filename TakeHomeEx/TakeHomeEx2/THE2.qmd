---
title: "Take-Home Exercise 1"
author:
  - name: Matthew Ho
    url: https://www.linkedin.com/in/matthewhoyiwen/
date: 02-11-2024
description: |
  Take-Home Exercise 2
categories:
  - Take-Home Exercise
format:
  html:
    toc: true
execute: 
  eval: true
  echo: true
  warning: false
---

## 1.0 Overview

## 2.0 Wrangling

```{r}
pacman::p_load(sf, tmap, tidyverse, ggplot2, smoothr, lubridate, sfdep)
```

```{r}
twv <- st_read(dsn = "data/geospatial", 
                 layer = "TAINAN_VILLAGE")
```

```{r}
dengued <- read_csv("data/aspatial/Dengue_Daily.csv")
```

```{r}
dengued <- dengued[, c(1, 10, 11)]
names(dengued)
```

```{r}
names(dengued) <- c("Onset", "X", "Y")
names(dengued)
```

```{r}
head(dengued)
```

```{r}
options(digits = 15)
```

```{r}
dengued[, c(2, 3)] <- lapply(dengued[, c(2, 3)], as.numeric)
head(dengued)
```

```{r}
sum(apply(dengued, 1, function(x) any(is.na(x))))
```

```{r}
dengued <- na.omit(dengued)
```

```{r}
sum(apply(dengued, 1, function(x) any(is.na(x))))
```

```{r}
hist(dengued$Onset, breaks = "days", xlab = "Date", ylab = "Frequency", main = "Histogram of Date Ranges")
```

```{r}
st_crs(twv)
```

```{r}
dengued_sf <- st_as_sf(dengued, coords = c("X", "Y"),
                      crs = 3824)
st_crs(dengued_sf)
```

```{r}
head(dengued_sf)
```

```{r}
twvsz <- twv[twv$TOWNID %in% c("D01", "D02", "D04", "D06", "D07", "D08", "D32", "D39"), ] %>% 
  subset(select = -NOTE)
```

```{r}
head(twvsz)
```

```{r}
plot(twvsz)
```

```{r}
u_twvsz <- st_union(twvsz)
plot(u_twvsz)
```

```{r}
unh_twvsz <- fill_holes(u_twvsz, units::set_units(1, "km^2"))
plot(unh_twvsz)
```

```{r}
diff_twvsz <- st_difference(unh_twvsz, u_twvsz)
plot(diff_twvsz)
```

```{r}
hole_victims <- st_intersection(dengued_sf, diff_twvsz)
head(hole_victims)
```

Epi weeks 31-50 2023: 30-07-23 to 16-12-23

```{r}
dengued_sf_epiweeks <- dengued_sf %>% filter(Onset >= as.Date("2023-07-30") & Onset <= as.Date("2023-12-16"))
```

```{r}
dengue_sf <- st_intersection(dengued_sf_epiweeks, u_twvsz)
```

```{r}
dengue_sf$epi_week <- epiweek(dengue_sf$Onset)
```


```{r}
write_rds(dengue_sf, "data/rds/dengue_sf.rds")
```

```{r}
tm_shape(u_twvsz) + 
  tm_polygons() +
tm_shape(dengue_sf) +
  tm_dots(col = "red")
```

```{r}
geo_dupes <- any(duplicated(dengue_sf$geometry))
geo_dupes
```

```{r}
vil_dupes <- any(duplicated(twvsz$VILLCODE))
vil_dupes
```

Keep the NA for geometry purposes
```{r}
dengue_vils_sf <- st_join(twvsz, dengue_sf)
```
```{r}
dengue_vils_sf[!rownames(dengue_vils_sf) %in% rownames(na.omit(dengue_vils_sf)), ]
```

```{r}
dengue_vils_sf <- dengue_vils_sf[!is.na(dengue_vils_sf$VILLCODE), ]
```

Account for the NA village
```{r}
dengue_vils_gb_vc <- dengue_vils_sf %>%
  group_by(VILLCODE, VILLENG) %>%
  summarise(count = sum(!is.na(epi_week)))
```
```{r}
dengue_vils_gb_vc_epi <- dengue_vils_sf %>%
  group_by(VILLCODE, epi_week) %>%
  summarise(count = sum(!is.na(epi_week)))
```

```{r}
plot(dengue_vils_gb_vc_epi)
```

```{r}
dengue_vils_gb_vc_epi$epi_week <- ifelse(is.na(dengue_vils_gb_vc_epi$epi_week), 31, dengue_vils_gb_vc_epi$epi_week)

template <- expand.grid(VILLCODE = unique(dengue_vils_gb_vc_epi$VILLCODE),
                        epi_week = unique(dengue_vils_gb_vc_epi$epi_week))

merged_df <- merge(template, dengue_vils_gb_vc_epi, by = c("VILLCODE", "epi_week"), all.x = TRUE)

merged_df$count[is.na(merged_df$count)] <- 0

merged_df <- select(merged_df, -geometry)

merged_df <- st_as_sf(distinct(merge(merged_df, dengue_vils_gb_vc_epi[, c("VILLCODE", "geometry")], 
                  by = "VILLCODE", suffixes = c("", ".y"), all.x = TRUE)))
```

```{r}
print(nrow(merged_df))
print(length(unique(merged_df$VILLCODE)))
print(length(unique(merged_df$epi_week)))
```

```{r}
spt <- as_spacetime(merged_df, "VILLCODE", "epi_week")
is_spacetime_cube(spt)
```

```{r}
activate(spt, "geometry")
```

```{r}
activate(spt, "data")
```

```{r}
write_rds(spt, "data/rds/spt.rds")
```

If data is full of landmines, the NA value remaining partially throughout the process was a dirty needle. It doesn't hurt much now, but it might mess me up in the long run.

## 3.0 EDA

```{r}
set.seed(42)
# tmap_options(check.and.fix = TRUE)
```

### 3.1 Global Spatial Autocorrelation

See 36 <=
```{r}
# plot(dengue_vils_gb_ew)
```

Inspired by 

https://jenpoer-is415-gaa-exercises.netlify.app/take-home-exercises/exe-02/the2#exploratory-data-analysis-eda-with-choropleth-maps
```{r}
choropleth_map_small_multiples <- function(df, varname, facet, colors) {
  tm_shape(df) +
    tm_polygons(col='white') +
  tm_shape(df) +
    tm_polygons(varname,
            palette = colors,
            style="quantile") +
    tm_facets(by=facet, free.coords = FALSE)
}
```

```{r}
choropleth_map_small_multiples(dengue_vils_gb_vc_epi, "count", "epi_week", "Blues")
```

```{r}
wm_q.nb <- st_contiguity(dengue_vils_gb_vc$geometry)
wm_q.wt <- st_weights(wm_q.nb, style = "W")
wm_q.count <- dengue_vils_gb_vc$count
```

```{r}
global_moran_test(wm_q.count,
           wm_q.nb,
           wm_q.wt,
           zero.policy = TRUE,
           na.action=na.omit)
```
```{r}
moran_mc_res = global_moran_perm(wm_q.count,
                wm_q.nb,
                wm_q.wt,
                nsim=999, 
                zero.policy = TRUE, 
                na.action=na.omit)
moran_mc_res
```

```{r}
summary(moran_mc_res$res[1:999])
```

```{r}
var(moran_mc_res$res[1:999])
```

```{r}
ggplot() + 
  aes(moran_mc_res$res[1:999]) + 
  geom_histogram(colour="black", fill="pink") + 
  labs(title = "Histogram of Simulated Moran's I For Tainan City Dengue Cases",
       x = "Simulated Moran's I",
       y = "Occurences") +
  theme_minimal()
```

```{r}
# MI_corr <- sp.correlogram(dv_total_wm_q, 
#                           dengue_vils_gb_vc$count, 
#                           order=8, 
#                           method="I", 
#                           style="W")
# plot(MI_corr)
# print(MI_corr)
```
### Local

```{r}
wm_q.lisa <- local_moran(wm_q.count, wm_q.nb, wm_q.wt)
dengue_vils_gb_vc <- cbind(dengue_vils_gb_vc, wm_q.lisa)
```

```{r}
p_val_2_cats <- function(x) {
  if (x < 0.005) {
    return("p < 0.005")
  } else if (x < 0.01) {
    return("p < 0.01")
  } else if (x < 0.05) {
    return("p < 0.05")
  } else {
    return("p > 0.05")
  }
}

dengue_vils_gb_vc <- dengue_vils_gb_vc %>%
  mutate(p_values = sapply(p_ii, p_val_2_cats))
```

```{r}
tm_shape(dengue_vils_gb_vc) +
  tm_fill(col = "ii", 
          style = "pretty",
          palette = "RdBu",
          title = "local moran statistics") +
  tm_borders(alpha = 0.5) + 
  
tm_shape(dengue_vils_gb_vc[dengue_vils_gb_vc$p_values != "p > 0.05", ]) +
  tm_symbols(col = "p_values",
             title.shape = "P Values:",
             shapes.labels = c("p < 0.05", "p < 0.01", "p < 0.005"),
             size = 0.1,
             palette=c('purple', 'hotpink', 'white'))
```
```{r}
lisa_sig <- dengue_vils_gb_vc  %>%
  filter(p_ii < 0.05)
tmap_mode("plot")

tm_shape(dengue_vils_gb_vc) +
  tm_polygons() +
  tm_borders(alpha = 0.5) +
tm_shape(lisa_sig) +
  tm_fill("mean") + 
  tm_borders(alpha = 0.4)
```

### Hot and Cold






























































































































































































































































































































































